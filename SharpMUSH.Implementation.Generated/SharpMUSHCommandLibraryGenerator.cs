using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using System.Collections.Immutable;
using System.Linq;

namespace SharpMUSH.Implementation.Generated;

using CommandInformation = (string Name, string ClassName, string MethodName, string AttributeName, string MinArgs, string MaxArgs, string CommandLock, string CommandBehavior, string[] Switches);

[Generator]
public sealed class SharpMUSHCommandLibraryGenerator : IIncrementalGenerator
{
	private const string ATTRIBUTENAME = "SharpMUSH.Library.Attributes.SharpCommandAttribute";

	public void Initialize(IncrementalGeneratorInitializationContext context)
	{
		var provider = context.SyntaxProvider.ForAttributeWithMetadataName(ATTRIBUTENAME,
				static (node, _) => node is MethodDeclarationSyntax,
				static (ctx, _) =>
					(Method: (MethodDeclarationSyntax)ctx.TargetNode,
					Attribute: ctx.Attributes.First(a => a.AttributeClass?.ToDisplayString() == ATTRIBUTENAME)))
			.Where(static x => x.Method is not null && x.Attribute is not null);

		var compilation = context.CompilationProvider.Combine(provider.Collect());

		context.RegisterSourceOutput(compilation, Execute);
	}

	private static CommandInformation Transform(MethodDeclarationSyntax syntax, AttributeData attr)
	{
		var name = syntax.Identifier.Text;
		var className = Helper.GetFullClassName(syntax);
		var methodName = syntax.Identifier.Text;
		var attrName = attr.NamedArguments.FirstOrDefault(kv => kv.Key == "Name").Value.Value?.ToString() ?? "";
		var minArgs = attr.NamedArguments.FirstOrDefault(kv => kv.Key == "MinArgs").Value.Value?.ToString() ?? "0";
		var maxArgs = attr.NamedArguments.FirstOrDefault(kv => kv.Key == "MaxArgs").Value.Value?.ToString() ?? "32";
		var commandLock = attr.NamedArguments.FirstOrDefault(kv => kv.Key == "CommandLock").Value.Value?.ToString() ?? string.Empty;
		var switchesArg = attr.NamedArguments.FirstOrDefault(kv => kv.Key == "Switches").Value;
		var commandBehavior = attr.NamedArguments.FirstOrDefault(kv => kv.Key == "Behavior").Value.Value?.ToString() ?? "0";
		var switches = switchesArg.Kind == TypedConstantKind.Array
			? switchesArg.Values.Select(v => v.Value?.ToString() ?? "").ToArray()
			: [];
		return (name, className, methodName, attrName, minArgs, maxArgs, commandLock, commandBehavior, switches);
	}

	private static void Execute(SourceProductionContext context,
		(Compilation Left, ImmutableArray<(MethodDeclarationSyntax Method, AttributeData Attribute)> list) tuple)
	{
		var list = tuple.list;
		var infoList = list.Select(item => Transform(item.Method, item.Attribute)).ToList();

		var code = $$"""
		             // Generated by SharpMUSHIncrementalGenerator
		             namespace SharpMUSH.Implementation.Generated; 
		             using System.Collections.Generic;

		             public static class CommandLibrary 
		             {
		               private static SharpMUSH.Library.Definitions.CommandDefinition CreateCommandDefinition(SharpMUSH.Library.Attributes.SharpCommandAttribute attr, Func<SharpMUSH.Library.ParserInterfaces.IMUSHCodeParser, SharpMUSH.Library.Attributes.SharpCommandAttribute, ValueTask<SharpMUSH.Library.DiscriminatedUnions.Option<SharpMUSH.Library.ParserInterfaces.CallState>>> method)
		                 => new SharpMUSH.Library.Definitions.CommandDefinition(attr, (parser) => method(parser, attr));
		             
		               public static readonly Dictionary<string, SharpMUSH.Library.Definitions.CommandDefinition> Commands = new Dictionary<string, SharpMUSH.Library.Definitions.CommandDefinition>
		               {
		                 {{string.Join(",\n\t\t", infoList.Select(InfoToSource))}}
		               };
		             }
		             """;

		context.AddSource("SharpMUSH.Implementation.Generated.CommandLibrary.g.cs", code);
	}

	private static string InfoToSource(CommandInformation info)
	{
		return
			$$"""
			  { 
			  			"{{info.AttributeName}}", 
			  			CreateCommandDefinition(
			  				new SharpMUSH.Library.Attributes.SharpCommandAttribute 
			  				{
			  					Name = "{{info.AttributeName}}",
			  					MinArgs = {{info.MinArgs}},
			  					MaxArgs = {{info.MaxArgs}},
			  					CommandLock = "{{info.CommandLock}}",
			  					Behavior = (SharpMUSH.Library.Definitions.CommandBehavior){{info.CommandBehavior}},
			  					Switches = [ {{string.Join(", ", info.Switches.Select(x => $"\"{x}\""))}} ]
			  				},
			  				{{info.ClassName}}.{{info.MethodName}})
			  		}
			  """;
	}
}