@page "/admin/config/network"
@layout ConfigLayout
@using SharpMUSH.Client.Services
@inject AdminConfigService AdminConfigService

<PageTitle>Network Configuration - SharpMUSH</PageTitle>

<div class="config-section-page">
    @* Header *@
    <div class="config-section-header">
        <MudText Typo="Typo.h4">Network Configuration</MudText>
        <MudText Typo="Typo.body1" Class="mud-text-secondary mt-2">
            Server connection and network settings
        </MudText>
    </div>

    @* Content *@
    <div class="config-section-content">
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Secondary" Indeterminate="true" />
        }
        else if (_netOptions != null)
        {
            @* Connection Settings Card *@
            <MudCard Outlined="true" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Connection Settings</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="uint" @bind-Value="_netOptions.Port"
                                           Label="Port"
                                           Variant="Variant.Outlined"
                                           HelperText="The port number the server listens on for incoming connections"
                                           Min="1"
                                           Max="65535" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="uint" @bind-Value="_netOptions.SslPort"
                                           Label="SSL Port"
                                           Variant="Variant.Outlined"
                                           HelperText="Port for SSL/TLS encrypted connections"
                                           Min="1"
                                           Max="65535" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudSwitch @bind-Value="_netOptions.UseSSL"
                                     Label="Enable SSL/TLS"
                                     Color="Color.Secondary" />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                Require encrypted connections for enhanced security
                            </MudText>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @* Connection Limits Card *@
            <MudCard Outlined="true" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Connection Limits</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="uint" @bind-Value="_netOptions.MaxConnections"
                                           Label="Maximum Connections"
                                           Variant="Variant.Outlined"
                                           HelperText="Maximum number of simultaneous player connections allowed"
                                           Min="1" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="uint" @bind-Value="_netOptions.ConnectionsPerIP"
                                           Label="Connections Per IP"
                                           Variant="Variant.Outlined"
                                           HelperText="Maximum connections allowed from a single IP address"
                                           Min="1" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField T="uint" @bind-Value="_netOptions.IdleTimeout"
                                           Label="Idle Timeout (seconds)"
                                           Variant="Variant.Outlined"
                                           HelperText="Disconnect players who are idle for this many seconds"
                                           Min="60" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            @* Network Protocol Card *@
            <MudCard Outlined="true" Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Network Protocol</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="3">
                        <div>
                            <MudSwitch @bind-Value="_netOptions.EnablePueblo"
                                     Label="Enable Pueblo/HTML Support"
                                     Color="Color.Secondary" />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                Allow clients to render HTML formatting
                            </MudText>
                        </div>
                        <div>
                            <MudSwitch @bind-Value="_netOptions.EnableIPv6"
                                     Label="Enable IPv6"
                                     Color="Color.Secondary" />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                Accept connections over IPv6 in addition to IPv4
                            </MudText>
                        </div>
                        <div>
                            <MudSwitch @bind-Value="_netOptions.EnableTelnet"
                                     Label="Enable Telnet Negotiation"
                                     Color="Color.Secondary" />
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                Support telnet protocol features
                            </MudText>
                        </div>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }
    </div>

    @* Save/Reset Bar *@
    @if (_hasChanges)
    {
        <MudPaper Elevation="4" Class="save-bar">
            <div class="save-bar-content">
                <div class="save-bar-info">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" Class="mr-2" />
                    <MudText Typo="Typo.body1"><strong>Unsaved changes</strong> in this section</MudText>
                </div>
                <div class="save-bar-actions">
                    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="ResetChanges">
                        Reset Changes
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="SaveChanges" StartIcon="@Icons.Material.Filled.Save">
                        Save Configuration
                    </MudButton>
                </div>
            </div>
        </MudPaper>
    }
</div>

<style>
    .config-section-page {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .config-section-header {
        padding: 24px 32px;
        background: var(--mud-palette-surface);
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
    }

    .config-section-content {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
    }

    .save-bar {
        position: sticky;
        bottom: 0;
        padding: 16px 32px;
        background: var(--mud-palette-surface);
        border-top: 2px solid var(--mud-palette-warning);
        z-index: 10;
    }

    .save-bar-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .save-bar-info {
        display: flex;
        align-items: center;
    }

    .save-bar-actions {
        display: flex;
        gap: 12px;
    }

    @@media (max-width: 600px) {
        .save-bar-content {
            flex-direction: column;
            gap: 12px;
        }

        .save-bar-actions {
            width: 100%;
            justify-content: stretch;
        }

        .save-bar-actions > * {
            flex: 1;
        }
    }
</style>

@code {
    private bool _loading = true;
    private bool _hasChanges = false;
    private NetOptionsModel? _netOptions;
    private NetOptionsModel? _originalOptions;

    // Temporary model until we connect to real config
    private class NetOptionsModel
    {
        public uint Port { get; set; } = 4201;
        public uint SslPort { get; set; } = 4202;
        public bool UseSSL { get; set; } = true;
        public uint MaxConnections { get; set; } = 100;
        public uint ConnectionsPerIP { get; set; } = 5;
        public uint IdleTimeout { get; set; } = 3600;
        public bool EnablePueblo { get; set; } = false;
        public bool EnableIPv6 { get; set; } = true;
        public bool EnableTelnet { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadNetworkConfig();
        _loading = false;
    }

    private async Task LoadNetworkConfig()
    {
        // TODO: Load from AdminConfigService
        // For now, use dummy data
        await Task.Delay(500); // Simulate loading
        
        _netOptions = new NetOptionsModel();
        _originalOptions = new NetOptionsModel
        {
            Port = _netOptions.Port,
            SslPort = _netOptions.SslPort,
            UseSSL = _netOptions.UseSSL,
            MaxConnections = _netOptions.MaxConnections,
            ConnectionsPerIP = _netOptions.ConnectionsPerIP,
            IdleTimeout = _netOptions.IdleTimeout,
            EnablePueblo = _netOptions.EnablePueblo,
            EnableIPv6 = _netOptions.EnableIPv6,
            EnableTelnet = _netOptions.EnableTelnet
        };

        // Simulate changes for demo
        _hasChanges = true;
    }

    private async Task SaveChanges()
    {
        // TODO: Save to server via AdminConfigService
        await Task.Delay(500);
        
        _hasChanges = false;
        StateHasChanged();
    }

    private void ResetChanges()
    {
        if (_originalOptions != null && _netOptions != null)
        {
            _netOptions.Port = _originalOptions.Port;
            _netOptions.SslPort = _originalOptions.SslPort;
            _netOptions.UseSSL = _originalOptions.UseSSL;
            _netOptions.MaxConnections = _originalOptions.MaxConnections;
            _netOptions.ConnectionsPerIP = _originalOptions.ConnectionsPerIP;
            _netOptions.IdleTimeout = _originalOptions.IdleTimeout;
            _netOptions.EnablePueblo = _originalOptions.EnablePueblo;
            _netOptions.EnableIPv6 = _originalOptions.EnableIPv6;
            _netOptions.EnableTelnet = _originalOptions.EnableTelnet;
            
            _hasChanges = false;
            StateHasChanged();
        }
    }
}
